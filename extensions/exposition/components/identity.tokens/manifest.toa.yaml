namespace: identity
name: tokens

entity:
  schema:
    revokedAt: integer # timestamp
  associated: true

operations:
  encrypt:
    input:
      authority*: string
      identity*: &identity
        id: string
        ...: true
      lifetime: integer[0,) # seconds
      scopes: [string]
      permissions:
        ~: [string]
    output: string
    errors:
      - ERR_INACCESSIBLE_SCOPE
  decrypt:
    input: string
    output:
      authority: string
      identity: *identity
      iat: string
      exp: string
      refresh: boolean
    errors:
      - INVALID_TOKEN
      - INVALID_KEY
  authenticate:
    input:
      authority*: string
      credentials*: string
    output:
      identity: *identity
      refresh: boolean
    errors:
      - AUTHORITY_MISMATCH
      - TOKEN_REVOKED
  revoke:
    concurrency: retry

receivers:
  identity.bans.created: revoke
  identity.bans.updated: revoke

configuration:
  keys:
    type: object
    minProperties: 1
    additionalProperties:
      type: string
  lifetime: 2592000 # seconds, 30 days
  refresh: 600      # seconds, 10 minutes

exposition:
  /:
    POST:
      auth:delegate: identity
      io:output: true # string
      map:authority: authority
      endpoint: encrypt
